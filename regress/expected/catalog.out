/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
LOAD 'age';
SET search_path TO ag_catalog;
--
-- create_graph(), drop_label(), and drop_graph() tests
--
SELECT create_graph('graph');
NOTICE:  graph "graph" has been created
 create_graph 
--------------
 
(1 row)

SELECT name, namespace FROM ag_graph WHERE name = 'graph';
 name  | namespace 
-------+-----------
 graph | graph
(1 row)

-- create a label to test drop_label()
SELECT * FROM cypher('graph', $$CREATE (:l)$$) AS r(a agtype);
 a 
---
(0 rows)

-- test drop_label()
SELECT drop_label('graph', 'l');
NOTICE:  label "graph"."l" has been dropped
 drop_label 
------------
 
(1 row)

-- create a label to test drop_graph()
SELECT * FROM cypher('graph', $$CREATE (:v)$$) AS r(a agtype);
 a 
---
(0 rows)

-- DROP SCHEMA ... CASCADE should fail
DROP SCHEMA graph CASCADE;
NOTICE:  drop cascades to 4 other objects
DETAIL:  drop cascades to sequence graph._label_id_seq
drop cascades to table graph._ag_label_vertex
drop cascades to table graph._ag_label_edge
drop cascades to table graph.v
ERROR:  table "v" is for label "v"
-- DROP TABLE ... should fail
DROP TABLE graph.v;
ERROR:  table "v" is for label "v"
-- should fail (cascade = false)
SELECT drop_graph('graph');
ERROR:  cannot drop schema graph because other objects depend on it
DETAIL:  table graph._ag_label_vertex depends on schema graph
table graph._ag_label_edge depends on schema graph
table graph.v depends on schema graph
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
SELECT drop_graph('graph', true);
NOTICE:  drop cascades to 3 other objects
DETAIL:  drop cascades to table graph._ag_label_vertex
drop cascades to table graph._ag_label_edge
drop cascades to table graph.v
NOTICE:  graph "graph" has been dropped
 drop_graph 
------------
 
(1 row)

SELECT count(*) FROM ag_graph WHERE name = 'graph';
 count 
-------
     0
(1 row)

SELECT count(*) FROM pg_namespace WHERE nspname = 'graph';
 count 
-------
     0
(1 row)

-- invalid cases
SELECT create_graph(NULL);
ERROR:  graph name can not be NULL
SELECT drop_graph(NULL);
ERROR:  graph name can not be NULL
SELECT create_graph('');
ERROR:  graph name is invalid
--
-- alter_graph() RENAME function tests
--
-- create 2 graphs for test.
SELECT create_graph('GraphA');
NOTICE:  graph "GraphA" has been created
 create_graph 
--------------
 
(1 row)

SELECT create_graph('GraphB');
NOTICE:  graph "GraphB" has been created
 create_graph 
--------------
 
(1 row)

-- Show GraphA's construction to verify case is preserved.
SELECT name, namespace FROM ag_graph WHERE name = 'GraphA';
  name  | namespace 
--------+-----------
 GraphA | "GraphA"
(1 row)

SELECT nspname FROM pg_namespace WHERE nspname = 'GraphA';
 nspname 
---------
 GraphA
(1 row)

-- Rename GraphA to GraphX.
SELECT alter_graph('GraphA', 'RENAME', 'GraphX');
NOTICE:  graph "GraphA" renamed to "GraphX"
 alter_graph 
-------------
 
(1 row)

-- Show GraphX's construction to verify case is preserved.
SELECT name, namespace FROM ag_graph WHERE name = 'GraphX';
  name  | namespace 
--------+-----------
 GraphX | "GraphX"
(1 row)

SELECT nspname FROM pg_namespace WHERE nspname = 'GraphX';
 nspname 
---------
 GraphX
(1 row)

-- Verify there isn't a graph GraphA anymore.
SELECT name, namespace FROM ag_graph WHERE name = 'GraphA';
 name | namespace 
------+-----------
(0 rows)

SELECT * FROM pg_namespace WHERE nspname = 'GraphA';
 oid | nspname | nspowner | nspacl 
-----+---------+----------+--------
(0 rows)

-- Sanity check that graphx does not exist - should return 0.
SELECT count(*) FROM ag_graph where name = 'graphx';
 count 
-------
     0
(1 row)

-- Verify case sensitivity (graphx does not exist, but GraphX does) - should fail.
SELECT alter_graph('graphx', 'RENAME', 'GRAPHX');
ERROR:  graph "graphx" does not exist
-- Checks for collisions (GraphB already exists) - should fail.
SELECT alter_graph('GraphX', 'RENAME', 'GraphB');
ERROR:  schema "GraphB" already exists
-- Remove graphs.
SELECT drop_graph('GraphX', true);
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to table "GraphX"._ag_label_vertex
drop cascades to table "GraphX"._ag_label_edge
NOTICE:  graph "GraphX" has been dropped
 drop_graph 
------------
 
(1 row)

SELECT drop_graph('GraphB', true);
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to table "GraphB"._ag_label_vertex
drop cascades to table "GraphB"._ag_label_edge
NOTICE:  graph "GraphB" has been dropped
 drop_graph 
------------
 
(1 row)

-- Verify that renaming a graph that does not exist fails.
SELECT alter_graph('GraphB', 'RENAME', 'GraphA');
ERROR:  graph "GraphB" does not exist
-- Verify NULL input checks.
SELECT alter_graph(NULL, 'RENAME', 'GraphA');
ERROR:  graph_name must not be NULL
SELECT alter_graph('GraphB', NULL, 'GraphA');
ERROR:  operation must not be NULL
SELECT alter_graph('GraphB', 'RENAME', NULL);
ERROR:  new_value must not be NULL
-- Verify invalid input check for operation parameter.
SELECT alter_graph('GraphB', 'DUMMY', 'GraphA');
ERROR:  invalid operation "DUMMY"
HINT:  valid operations: RENAME
--
-- label id test
--
SELECT create_graph('graph');
NOTICE:  graph "graph" has been created
 create_graph 
--------------
 
(1 row)

-- label id starts from 1
SELECT * FROM cypher('graph', $$CREATE (:v1)$$) AS r(a agtype);
 a 
---
(0 rows)

SELECT name, id, kind, relation FROM ag_label;
       name       | id | kind |        relation        
------------------+----+------+------------------------
 _ag_label_vertex |  1 | v    | graph._ag_label_vertex
 _ag_label_edge   |  2 | e    | graph._ag_label_edge
 v1               |  3 | v    | graph.v1
(3 rows)

-- skip label id 2 to test the logic that gets an unused label id after cycle
SELECT nextval('graph._label_id_seq');
 nextval 
---------
       4
(1 row)

-- label id is now 3
SELECT * FROM cypher('graph', $$CREATE (:v3)$$) as r(a agtype);
 a 
---
(0 rows)

SELECT name, id, kind, relation FROM ag_label;
       name       | id | kind |        relation        
------------------+----+------+------------------------
 _ag_label_vertex |  1 | v    | graph._ag_label_vertex
 _ag_label_edge   |  2 | e    | graph._ag_label_edge
 v1               |  3 | v    | graph.v1
 v3               |  5 | v    | graph.v3
(4 rows)

-- to use 65535 as the next label id, set label id to 65534
SELECT setval('graph._label_id_seq', 65534);
 setval 
--------
  65534
(1 row)

-- label id is now 65535
SELECT * FROM cypher('graph', $$CREATE (:v65535)$$) as r(a agtype);
 a 
---
(0 rows)

SELECT name, id, kind, relation FROM ag_label;
       name       |  id   | kind |        relation        
------------------+-------+------+------------------------
 _ag_label_vertex |     1 | v    | graph._ag_label_vertex
 _ag_label_edge   |     2 | e    | graph._ag_label_edge
 v1               |     3 | v    | graph.v1
 v3               |     5 | v    | graph.v3
 v65535           | 65535 | v    | graph.v65535
(5 rows)

-- after cycle, label id is now 2
SELECT * FROM cypher('graph', $$CREATE (:v2)$$) as r(a agtype);
 a 
---
(0 rows)

SELECT name, id, kind, relation FROM ag_label;
       name       |  id   | kind |        relation        
------------------+-------+------+------------------------
 _ag_label_vertex |     1 | v    | graph._ag_label_vertex
 _ag_label_edge   |     2 | e    | graph._ag_label_edge
 v1               |     3 | v    | graph.v1
 v3               |     5 | v    | graph.v3
 v65535           | 65535 | v    | graph.v65535
 v2               |     4 | v    | graph.v2
(6 rows)

SELECT drop_graph('graph', true);
NOTICE:  drop cascades to 6 other objects
DETAIL:  drop cascades to table graph._ag_label_vertex
drop cascades to table graph._ag_label_edge
drop cascades to table graph.v1
drop cascades to table graph.v3
drop cascades to table graph.v65535
drop cascades to table graph.v2
NOTICE:  graph "graph" has been dropped
 drop_graph 
------------
 
(1 row)

-- create labels
SELECT create_graph('graph');
NOTICE:  graph "graph" has been created
 create_graph 
--------------
 
(1 row)

SELECT create_vlabel('graph', 'n');
NOTICE:  VLabel "n" has been created
 create_vlabel 
---------------
 
(1 row)

SELECT create_elabel('graph', 'r');
NOTICE:  ELabel "r" has been created
 create_elabel 
---------------
 
(1 row)

-- check if labels have been created or not
SELECT name, id, kind, relation FROM ag_label;
       name       | id | kind |        relation        
------------------+----+------+------------------------
 _ag_label_vertex |  1 | v    | graph._ag_label_vertex
 _ag_label_edge   |  2 | e    | graph._ag_label_edge
 n                |  3 | v    | graph.n
 r                |  4 | e    | graph.r
(4 rows)

-- try to create duplicate labels
SELECT create_vlabel('graph', 'n');
ERROR:  label "n" already exists
SELECT create_elabel('graph', 'r');
ERROR:  label "r" already exists
-- remove the labels that have been created
SELECT drop_label('graph', 'n', false);
NOTICE:  label "graph"."n" has been dropped
 drop_label 
------------
 
(1 row)

SELECT drop_label('graph', 'r', false);
NOTICE:  label "graph"."r" has been dropped
 drop_label 
------------
 
(1 row)

-- check if labels have been deleted or not
SELECT name, id, kind, relation FROM ag_label;
       name       | id | kind |        relation        
------------------+----+------+------------------------
 _ag_label_vertex |  1 | v    | graph._ag_label_vertex
 _ag_label_edge   |  2 | e    | graph._ag_label_edge
(2 rows)

-- try to remove labels that is not there
SELECT drop_label('graph', 'n');
ERROR:  label "n" does not exist
SELECT drop_label('graph', 'r');
ERROR:  label "r" does not exist
-- Trying to call the functions with label null
SELECT create_vlabel('graph', NULL);
ERROR:  label name must not be NULL
SELECT create_elabel('graph', NULL);
ERROR:  label name must not be NULL
-- Trying to call the functions with graph null
SELECT create_vlabel(NULL, 'n');
ERROR:  graph name must not be NULL
SELECT create_elabel(NULL, 'r');
ERROR:  graph name must not be NULL
-- Trying to call the functions with both null
SELECT create_vlabel(NULL, NULL);
ERROR:  graph name must not be NULL
SELECT create_elabel(NULL, NULL);
ERROR:  graph name must not be NULL
-- age_graph_exists()
CREATE FUNCTION raise_notice(graph_name TEXT)
RETURNS void AS $$
DECLARE
    res BOOLEAN;
BEGIN
    -- this tests whether graph_exists works with IF-ELSE.
    SELECT graph_exists('graph1') INTO res;
    IF res THEN
        RAISE NOTICE 'graph exists';
    ELSE
        RAISE NOTICE 'graph does not exist';
    END IF;
END  $$ LANGUAGE plpgsql;
SELECT graph_exists('graph1');
 graph_exists 
--------------
 false
(1 row)

SELECT create_graph('graph1');
NOTICE:  graph "graph1" has been created
 create_graph 
--------------
 
(1 row)

SELECT graph_exists('graph1');
 graph_exists 
--------------
 true
(1 row)

SELECT raise_notice('graph1');
NOTICE:  graph exists
 raise_notice 
--------------
 
(1 row)

SELECT drop_graph('graph1', true);
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to table graph1._ag_label_vertex
drop cascades to table graph1._ag_label_edge
NOTICE:  graph "graph1" has been dropped
 drop_graph 
------------
 
(1 row)

SELECT graph_exists('graph1');
 graph_exists 
--------------
 false
(1 row)

SELECT raise_notice('graph1');
NOTICE:  graph does not exist
 raise_notice 
--------------
 
(1 row)

DROP FUNCTION raise_notice(TEXT);
--
-- Fix issue 2245 - Creating more than 41 vlabels causes drop_graph to fail with
--  label (relation) cache corrupted
--
-- this result will change if another graph was created prior to this point.
SELECT count(*) FROM ag_label;
 count 
-------
     2
(1 row)

SELECT * FROM create_graph('issue_2245');
NOTICE:  graph "issue_2245" has been created
 create_graph 
--------------
 
(1 row)

SELECT * FROM cypher('issue_2245', $$
  CREATE (a1:Part1 {part_num: '123'}), (a2:Part2 {part_num: '345'}), (a3:Part3 {part_num: '456'}),
         (a4:Part4 {part_num: '789'}), (a5:Part5 {part_num: '123'}), (a6:Part6 {part_num: '345'}),
         (a7:Part7 {part_num: '456'}), (a8:Part8 {part_num: '789'}), (a9:Part9 {part_num: '123'}),
         (a10:Part10 {part_num: '345'}), (a11:Part11 {part_num: '456'}), (a12:Part12 {part_num: '789'}),
         (a13:Part13 {part_num: '123'}), (a14:Part14 {part_num: '345'}), (a15:Part15 {part_num: '456'}),
         (a16:Part16 {part_num: '789'}), (a17:Part17 {part_num: '123'}), (a18:Part18 {part_num: '345'}),
         (a19:Part19 {part_num: '456'}), (a20:Part20 {part_num: '789'}), (a21:Part21 {part_num: '123'}),
         (a22:Part22 {part_num: '345'}), (a23:Part23 {part_num: '456'}), (a24:Part24 {part_num: '789'}),
         (a25:Part25 {part_num: '123'}), (a26:Part26 {part_num: '345'}), (a27:Part27 {part_num: '456'}),
         (a28:Part28 {part_num: '789'}), (a29:Part29 {part_num: '789'}), (a30:Part30 {part_num: '123'}),
         (a31:Part31 {part_num: '345'}), (a32:Part32 {part_num: '456'}), (a33:Part33 {part_num: '789'}),
         (a34:Part34 {part_num: '123'}), (a35:Part35 {part_num: '345'}), (a36:Part36 {part_num: '456'}),
         (a37:Part37 {part_num: '789'}), (a38:Part38 {part_num: '123'}), (a39:Part39 {part_num: '345'}),
         (a40:Part40 {part_num: '456'}), (a41:Part41 {part_num: '789'}), (a42:Part42 {part_num: '345'}),
         (a43:Part43 {part_num: '456'}), (a44:Part44 {part_num: '789'}), (a45:Part45 {part_num: '456'}),
         (a46:Part46 {part_num: '789'}), (a47:Part47 {part_num: '456'}), (a48:Part48 {part_num: '789'}),
         (a49:Part49 {part_num: '789'}), (a50:Part50 {part_num: '456'}), (a51:Part51 {part_num: '789'})
  $$) AS (result agtype);
 result 
--------
(0 rows)

SELECT count(*) FROM ag_label;
 count 
-------
    55
(1 row)

SELECT drop_graph('issue_2245', true);
NOTICE:  drop cascades to 53 other objects
DETAIL:  drop cascades to table issue_2245._ag_label_vertex
drop cascades to table issue_2245._ag_label_edge
drop cascades to table issue_2245."Part1"
drop cascades to table issue_2245."Part2"
drop cascades to table issue_2245."Part3"
drop cascades to table issue_2245."Part4"
drop cascades to table issue_2245."Part5"
drop cascades to table issue_2245."Part6"
drop cascades to table issue_2245."Part7"
drop cascades to table issue_2245."Part8"
drop cascades to table issue_2245."Part9"
drop cascades to table issue_2245."Part10"
drop cascades to table issue_2245."Part11"
drop cascades to table issue_2245."Part12"
drop cascades to table issue_2245."Part13"
drop cascades to table issue_2245."Part14"
drop cascades to table issue_2245."Part15"
drop cascades to table issue_2245."Part16"
drop cascades to table issue_2245."Part17"
drop cascades to table issue_2245."Part18"
drop cascades to table issue_2245."Part19"
drop cascades to table issue_2245."Part20"
drop cascades to table issue_2245."Part21"
drop cascades to table issue_2245."Part22"
drop cascades to table issue_2245."Part23"
drop cascades to table issue_2245."Part24"
drop cascades to table issue_2245."Part25"
drop cascades to table issue_2245."Part26"
drop cascades to table issue_2245."Part27"
drop cascades to table issue_2245."Part28"
drop cascades to table issue_2245."Part29"
drop cascades to table issue_2245."Part30"
drop cascades to table issue_2245."Part31"
drop cascades to table issue_2245."Part32"
drop cascades to table issue_2245."Part33"
drop cascades to table issue_2245."Part34"
drop cascades to table issue_2245."Part35"
drop cascades to table issue_2245."Part36"
drop cascades to table issue_2245."Part37"
drop cascades to table issue_2245."Part38"
drop cascades to table issue_2245."Part39"
drop cascades to table issue_2245."Part40"
drop cascades to table issue_2245."Part41"
drop cascades to table issue_2245."Part42"
drop cascades to table issue_2245."Part43"
drop cascades to table issue_2245."Part44"
drop cascades to table issue_2245."Part45"
drop cascades to table issue_2245."Part46"
drop cascades to table issue_2245."Part47"
drop cascades to table issue_2245."Part48"
drop cascades to table issue_2245."Part49"
drop cascades to table issue_2245."Part50"
drop cascades to table issue_2245."Part51"
NOTICE:  graph "issue_2245" has been dropped
 drop_graph 
------------
 
(1 row)

-- this result should be the same as the one before the create_graph
SELECT count(*) FROM ag_label;
 count 
-------
     2
(1 row)

-- create the graph again
SELECT * FROM create_graph('issue_2245');
NOTICE:  graph "issue_2245" has been created
 create_graph 
--------------
 
(1 row)

SELECT count(*) FROM ag_label;
 count 
-------
     4
(1 row)

-- dropping the graphs
SELECT drop_graph('issue_2245', true);
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to table issue_2245._ag_label_vertex
drop cascades to table issue_2245._ag_label_edge
NOTICE:  graph "issue_2245" has been dropped
 drop_graph 
------------
 
(1 row)

SELECT drop_graph('graph', true);
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to table graph._ag_label_vertex
drop cascades to table graph._ag_label_edge
NOTICE:  graph "graph" has been dropped
 drop_graph 
------------
 
(1 row)

